"""
é…ç½®æ¨¡å—ï¼šç³»ç»Ÿå‚æ•°ã€æšä¸¾ç±»å‹å®šä¹‰
å¯¹åº”è®¾è®¡ä¹¦ï¼šç¬¬9èŠ‚å‚æ•°ç®¡ç†ç­–ç•¥ + Table 2

ğŸ”´ v1.4ä¿®æ­£ç‰ˆ - ä¿®æ­£å…³é”®å‚æ•°
"""

from dataclasses import dataclass
from enum import Enum


class PassengerType(Enum):
    """ä¹˜å®¢ç±»å‹æšä¸¾"""
    PA1 = "PA1"  # å¸¦åŒ…ä¹˜å®¢ï¼ˆéœ€å®‰æ£€ï¼‰
    PA2 = "PA2"  # æ— åŒ…ä¹˜å®¢ï¼ˆå¿«é€Ÿé€šé“ï¼‰


class Position(Enum):
    """ä¹˜å®¢ä½ç½®çŠ¶æ€æšä¸¾"""
    SA1 = "SA1"  # å­åŒºåŸŸ1
    PW1 = "PW1"  # é€šé“1ï¼ˆå®‰æ£€é€šé“ï¼‰
    PW2 = "PW2"  # é€šé“2ï¼ˆå¿«é€Ÿé€šé“ï¼‰
    SA3 = "SA3"  # å­åŒºåŸŸ3ï¼ˆæ£€ç¥¨å‰ç­‰å€™åŒºï¼‰
    PASSED = "PASSED"  # å·²é€šè¿‡ç³»ç»Ÿ


@dataclass
class SystemParameters:
    """ç³»ç»Ÿå‚æ•°å°è£…ï¼ˆTable 2ï¼‰

    åŒ…å«ï¼š
    - å‡ ä½•å‚æ•°ï¼ˆé•¿åº¦ã€é¢ç§¯ï¼‰
    - é€Ÿåº¦å‚æ•°ï¼ˆè‡ªç”±æµé€Ÿåº¦ã€ä¼ é€å¸¦é€Ÿåº¦ï¼‰
    - å¯†åº¦å‚æ•°ï¼ˆé˜ˆå€¼å¯†åº¦ã€æœ€å¤§å¯†åº¦ï¼‰
    - æœåŠ¡å‚æ•°ï¼ˆæ”¾ç‰©/å–ç‰©/åˆ·å¡æ—¶é—´ã€é—¸æœºæ•°é‡ï¼‰
    - ä»¿çœŸå‚æ•°ï¼ˆæ—¶é—´æ­¥é•¿ï¼‰
    - æ´¾ç”Ÿå±æ€§ï¼ˆPW2å®½åº¦ï¼‰
    - é€Ÿåº¦-å¯†åº¦å‡½æ•°ï¼ˆEq.5, Eq.8ï¼‰

    ğŸ”´ v1.4ä¿®æ­£ï¼š
    - W_B: 0.45 â†’ 0.5mï¼ˆäººä½“å®½åº¦ï¼‰
    - A_SA3: 29.7 â†’ 21.8mÂ²ï¼ˆSA3åŒºåŸŸé¢ç§¯ï¼‰
    - t_pi, t_tiç°åœ¨æ˜ç¡®å®šä¹‰ï¼ˆä¹‹å‰å·²æœ‰ä½†éœ€å¼ºè°ƒï¼‰
    """

    # ==================== å‡ ä½•å‚æ•° ====================
    L_EN_PW1: float = 5.36  # å…¥å£åˆ°PW1è·ç¦» (m)
    L_EN_PW2: float = 4.69  # å…¥å£åˆ°PW2è·ç¦» (m)
    L_PW2: float = 4.55  # PW2é€šé“é•¿åº¦ (m)
    L_SE: float = 2.3  # Xå…‰æœºä¼ é€å¸¦é•¿åº¦ (m)
    L_PW1_GA: float = 3.65  # PW1åˆ°é—¸æœºè·ç¦» (m)
    L_PW2_GA: float = 4.07  # PW2åˆ°é—¸æœºè·ç¦» (m)
    A_PW2: float = 10.2  # PW2é¢ç§¯ (mÂ²)

    # ğŸ”´ ä¿®æ­£1ï¼šA_SA3ä»29.7æ”¹ä¸º21.8ï¼ˆåŸºäºè®ºæ–‡Table 2ï¼‰
    A_SA3: float = 21.8  # SA3é¢ç§¯ (mÂ²) - ä¿®æ­£å€¼

    # ğŸ”´ ä¿®æ­£2ï¼šW_Bä»0.45æ”¹ä¸º0.5ï¼ˆäººä½“å®½åº¦ï¼‰
    W_B: float = 0.5  # ä¹˜å®¢ä½“å®½ (m) - ä¿®æ­£å€¼

    # ==================== é€Ÿåº¦å‚æ•° ====================
    v0: float = 1.61  # è‡ªç”±æµé€Ÿåº¦ (m/s)
    v_SE: float = 0.2  # ä¼ é€å¸¦é€Ÿåº¦ (m/s)
    v_PW2_init: float = 1.61  # PW2è‡ªç”±æµé€Ÿåº¦ (m/s)
    v_SA3_init: float = 1.61  # SA3è‡ªç”±æµé€Ÿåº¦ (m/s)

    # ==================== å¯†åº¦å‚æ•° ====================
    K_PW2_init: float = 0.31  # PW2å¯†åº¦é˜ˆå€¼ (ped/mÂ²)
    K_SA3_init: float = 0.31  # SA3å¯†åº¦é˜ˆå€¼ (ped/mÂ²)
    K_PW2_max: float = 3.5  # PW2æœ€å¤§å¯†åº¦ (ped/mÂ²)
    K_SA3_max: float = 3.5  # SA3æœ€å¤§å¯†åº¦ (ped/mÂ²)

    # ==================== æœåŠ¡å‚æ•° ====================
    # ğŸ”´ å¼ºè°ƒï¼šè¿™ä¸¤ä¸ªå‚æ•°å¯¹PW1åŸºæœ¬æ—¶é—´è®¡ç®—è‡³å…³é‡è¦
    t_pi: float = 2.0  # æ”¾ç‰©æ—¶é—´ (s) - è®ºæ–‡æ˜ç¡®å®šä¹‰
    t_ti: float = 2.0  # å–ç‰©æ—¶é—´ (s) - è®ºæ–‡æ˜ç¡®å®šä¹‰

    t_s: float = 3.5  # åˆ·å¡/æ‰«ç æ—¶é—´ (s)
    N_G: int = 5  # é—¸æœºæ•°é‡

    # ==================== ä»¿çœŸå‚æ•° ====================
    dt: float = 0.1  # æ—¶é—´æ­¥é•¿ (s)

    # ==================== æ´¾ç”Ÿå±æ€§ ====================

    @property
    def W_PW2(self) -> float:
        """PW2å®½åº¦ï¼ˆå‡è®¾çŸ©å½¢é€šé“ï¼‰

        Returns:
            float: PW2å®½åº¦ (m)

        Note:
            åŸºäº"PW2ä¸ºçŸ©å½¢é€šé“"çš„å·¥ç¨‹è¿‘ä¼¼
            W_PW2 = A_PW2 / L_PW2
        """
        return self.A_PW2 / self.L_PW2

    # ==================== é€Ÿåº¦-å¯†åº¦å‡½æ•° ====================

    def v_PW2(self, K: float) -> float:
        """PW2é€Ÿåº¦-å¯†åº¦å…³ç³»ï¼ˆEq.5ï¼‰

        Args:
            K: å½“å‰å¯†åº¦ (ped/mÂ²)

        Returns:
            float: å¯¹åº”é€Ÿåº¦ (m/s)

        Note:
            - K <= K_PW2_init: è‡ªç”±æµé€Ÿåº¦
            - K > K_PW2_init: åˆ†æ®µä¸‰æ¬¡å¤šé¡¹å¼
            - åŒ…å«æ•°å€¼ä¿æŠ¤: v >= 0.01 m/s
        """
        if K <= self.K_PW2_init:
            return self.v_PW2_init
        else:
            x = K - self.K_PW2_init
            v = 0.11 * x ** 3 - 0.53 * x ** 2 + 0.15 * x + 1.61
            return max(v, 0.01)  # æ•°å€¼ä¿æŠ¤ï¼šé¿å…è´Ÿé€Ÿåº¦æˆ–é™¤é›¶

    def v_SA3(self, K: float) -> float:
        """SA3é€Ÿåº¦-å¯†åº¦å…³ç³»ï¼ˆEq.8ï¼‰

        Args:
            K: å½“å‰å¯†åº¦ (ped/mÂ²)

        Returns:
            float: å¯¹åº”é€Ÿåº¦ (m/s)

        Note:
            - K <= K_SA3_init: è‡ªç”±æµé€Ÿåº¦
            - K > K_SA3_init: åˆ†æ®µä¸‰æ¬¡å¤šé¡¹å¼ï¼ˆä¸PW2ç›¸åŒå½¢å¼ï¼‰
            - åŒ…å«æ•°å€¼ä¿æŠ¤: v >= 0.01 m/s
        """
        if K <= self.K_SA3_init:
            return self.v_SA3_init
        else:
            y = K - self.K_SA3_init
            v = 0.11 * y ** 3 - 0.53 * y ** 2 + 0.15 * y + 1.61
            return max(v, 0.01)  # æ•°å€¼ä¿æŠ¤ï¼šé¿å…è´Ÿé€Ÿåº¦æˆ–é™¤é›¶


# ==================== é»˜è®¤å‚æ•°å®ä¾‹ ====================

DEFAULT_PARAMS = SystemParameters()

# ==================== æ¨¡å—æµ‹è¯•å‡½æ•° ====================

if __name__ == "__main__":
    """æ¨¡å—è‡ªæµ‹ï¼šéªŒè¯å‚æ•°é…ç½®æ­£ç¡®æ€§"""

    print("=" * 60)
    print("ç³»ç»Ÿå‚æ•°é…ç½®è‡ªæµ‹ï¼ˆv1.4ä¿®æ­£ç‰ˆï¼‰")
    print("=" * 60)

    params = SystemParameters()

    # ğŸ”´ æ–°å¢æµ‹è¯•ï¼šéªŒè¯å…³é”®ä¿®æ­£
    print(f"\n[éªŒè¯v1.4ä¿®æ­£]")
    print(f"  W_B (äººä½“å®½åº¦): {params.W_B}m (åº”ä¸º0.5m)")
    print(f"  A_SA3 (SA3é¢ç§¯): {params.A_SA3}mÂ² (åº”ä¸º21.8mÂ²)")
    print(f"  t_pi (æ”¾ç‰©æ—¶é—´): {params.t_pi}s (åº”ä¸º2.0s)")
    print(f"  t_ti (å–ç‰©æ—¶é—´): {params.t_ti}s (åº”ä¸º2.0s)")

    assert params.W_B == 0.5, "W_Båº”ä¸º0.5m"
    assert params.A_SA3 == 21.8, "A_SA3åº”ä¸º21.8mÂ²"
    assert params.t_pi == 2.0, "t_piåº”ä¸º2.0s"
    assert params.t_ti == 2.0, "t_tiåº”ä¸º2.0s"
    print("  âœ“ v1.4ä¿®æ­£éªŒè¯é€šè¿‡")

    # æµ‹è¯•1ï¼šæ´¾ç”Ÿå±æ€§
    print(f"\n[æµ‹è¯•1] æ´¾ç”Ÿå±æ€§è®¡ç®—")
    print(f"  A_PW2 = {params.A_PW2} mÂ²")
    print(f"  L_PW2 = {params.L_PW2} m")
    print(f"  W_PW2 = {params.W_PW2:.3f} m")
    print(f"  éªŒè¯: W_PW2 = A_PW2 / L_PW2 = {params.A_PW2 / params.L_PW2:.3f} m")
    assert abs(params.W_PW2 - params.A_PW2 / params.L_PW2) < 1e-6, "æ´¾ç”Ÿå±æ€§è®¡ç®—é”™è¯¯"
    print("  âœ“ é€šè¿‡")

    # ğŸ”´ æ–°å¢æµ‹è¯•ï¼šPW2å¹¶è¡Œäººæ•°ï¼ˆéªŒè¯W_Bå½±å“ï¼‰
    print(f"\n[æµ‹è¯•1.5] PW2å¹¶è¡Œäººæ•°ï¼ˆå—W_Bå½±å“ï¼‰")
    max_parallel = int(params.W_PW2 / params.W_B)
    print(f"  W_PW2 = {params.W_PW2:.3f}m")
    print(f"  W_B = {params.W_B}m")
    print(f"  max_parallel = floor(W_PW2 / W_B) = {max_parallel}äºº")
    print(f"  (W_B=0.45æ—¶ä¸º{int(params.W_PW2/0.45)}äººï¼ŒW_B=0.5æ—¶ä¸º{max_parallel}äºº)")
    print("  âœ“ é€šè¿‡")

    # æµ‹è¯•2ï¼šé€Ÿåº¦-å¯†åº¦å‡½æ•°ï¼ˆPW2ï¼‰
    print(f"\n[æµ‹è¯•2] PW2é€Ÿåº¦-å¯†åº¦å‡½æ•°")
    test_densities = [0.0, 0.31, 1.0, 2.0, 3.5, 10.0]
    print(f"  {'å¯†åº¦ K (ped/mÂ²)':<20} {'é€Ÿåº¦ v (m/s)':<15} {'è¯´æ˜'}")
    print(f"  {'-' * 20} {'-' * 15} {'-' * 30}")
    for K in test_densities:
        v = params.v_PW2(K)
        status = "è‡ªç”±æµ" if K <= params.K_PW2_init else "æ‹¥å µ" if v > 0.01 else "æ•°å€¼ä¿æŠ¤"
        print(f"  {K:<20.2f} {v:<15.4f} {status}")
        assert v >= 0.01, f"æ•°å€¼ä¿æŠ¤å¤±è´¥: v_PW2({K}) = {v} < 0.01"
    print("  âœ“ é€šè¿‡ï¼ˆæ‰€æœ‰é€Ÿåº¦ >= 0.01 m/sï¼‰")

    # æµ‹è¯•3ï¼šé€Ÿåº¦-å¯†åº¦å‡½æ•°ï¼ˆSA3ï¼‰
    print(f"\n[æµ‹è¯•3] SA3é€Ÿåº¦-å¯†åº¦å‡½æ•°")
    print(f"  {'å¯†åº¦ K (ped/mÂ²)':<20} {'é€Ÿåº¦ v (m/s)':<15} {'è¯´æ˜'}")
    print(f"  {'-' * 20} {'-' * 15} {'-' * 30}")
    for K in test_densities:
        v = params.v_SA3(K)
        status = "è‡ªç”±æµ" if K <= params.K_SA3_init else "æ‹¥å µ" if v > 0.01 else "æ•°å€¼ä¿æŠ¤"
        print(f"  {K:<20.2f} {v:<15.4f} {status}")
        assert v >= 0.01, f"æ•°å€¼ä¿æŠ¤å¤±è´¥: v_SA3({K}) = {v} < 0.01"
    print("  âœ“ é€šè¿‡ï¼ˆæ‰€æœ‰é€Ÿåº¦ >= 0.01 m/sï¼‰")

    # æµ‹è¯•4ï¼šé€Ÿåº¦å•è°ƒæ€§ï¼ˆå¯†åº¦å¢åŠ ï¼Œé€Ÿåº¦é™ä½ï¼‰
    print(f"\n[æµ‹è¯•4] é€Ÿåº¦å•è°ƒæ€§æ£€æŸ¥")
    K_low = 0.5
    K_high = 2.0
    v_pw2_low = params.v_PW2(K_low)
    v_pw2_high = params.v_PW2(K_high)
    v_sa3_low = params.v_SA3(K_low)
    v_sa3_high = params.v_SA3(K_high)

    print(f"  PW2: v({K_low}) = {v_pw2_low:.4f} > v({K_high}) = {v_pw2_high:.4f}")
    print(f"  SA3: v({K_low}) = {v_sa3_low:.4f} > v({K_high}) = {v_sa3_high:.4f}")
    assert v_pw2_low > v_pw2_high, "PW2é€Ÿåº¦å•è°ƒæ€§é”™è¯¯"
    assert v_sa3_low > v_sa3_high, "SA3é€Ÿåº¦å•è°ƒæ€§é”™è¯¯"
    print("  âœ“ é€šè¿‡ï¼ˆå¯†åº¦è¶Šé«˜ï¼Œé€Ÿåº¦è¶Šä½ï¼‰")

    # æµ‹è¯•5ï¼šæšä¸¾ç±»å‹
    print(f"\n[æµ‹è¯•5] æšä¸¾ç±»å‹å®šä¹‰")
    print(f"  ä¹˜å®¢ç±»å‹: {[pt.value for pt in PassengerType]}")
    print(f"  ä½ç½®çŠ¶æ€: {[pos.value for pos in Position]}")
    assert len(PassengerType) == 2, "ä¹˜å®¢ç±»å‹æ•°é‡é”™è¯¯"
    assert len(Position) == 5, "ä½ç½®çŠ¶æ€æ•°é‡é”™è¯¯"
    print("  âœ“ é€šè¿‡")

    print("\n" + "=" * 60)
    print("æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼å‚æ•°é…ç½®æ­£ç¡®ï¼ˆv1.4ä¿®æ­£ç‰ˆï¼‰ã€‚")
    print("=" * 60)

    # ğŸ”´ æ˜¾ç¤ºä¿®æ­£æ‘˜è¦
    print("\n" + "=" * 60)
    print("v1.4ä¿®æ­£æ‘˜è¦:")
    print("=" * 60)
    print("1. W_B: 0.45m â†’ 0.5m")
    print("2. A_SA3: 29.7mÂ² â†’ 21.8mÂ²")
    print("3. t_pi, t_ti: å·²æ˜ç¡®å®šä¹‰ä¸º2.0s")
    print("4. SA3å®¹é‡: 104äºº â†’ 76äººï¼ˆæ›´æ˜“é¥±å’Œï¼‰")
    print("5. PW2å¹¶è¡Œ: 4äººï¼ˆä¸å˜ï¼Œå› floor(2.24/0.45)=floor(2.24/0.5)=4ï¼‰")
    print("=" * 60)
